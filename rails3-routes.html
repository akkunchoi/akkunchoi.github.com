<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Akkunchoi.github.com : " />

    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>Rails3 routes.rb まとめ | akkunchoi@github</title>
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for mysite.com" href="/feed.xml" />
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/akkunchoi">View on GitHub</a>

          <h1 id="project_title">
            <a href="/">akkunchoi.github.com</a>
          </h1>
          <h2 id="project_tagline"></h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">

      <article class="posts">
  <header>
    <h1>Rails3 routes.rb まとめ</h1>
    <ul class="tags">
      
      <li class="inline archive_list"><a class="tag_list_link" href="/tag/ruby">ruby</a></li>
      
      <li class="inline archive_list"><a class="tag_list_link" href="/tag/rails">rails</a></li>
      
    </ul>
  </header>
  <div class="posts-content">
  <ul id="markdown-toc">
  <li><a href="#section">はじめに</a></li>
  <li><a href="#rails">ルーティングとRails</a></li>
  <li><a href="#resource-routing">Resource Routing</a>    <ul>
      <li><a href="#resources---">resources - 基本</a></li>
      <li><a href="#resource---id">resource - idを伴わない場合</a></li>
      <li><a href="#namespace---path-and-controller-prefix">namespace - path and controller prefix</a></li>
      <li><a href="#scope---controller-prefix">scope - controller prefix</a></li>
      <li><a href="#scope---path-prefix">scope - path prefix</a></li>
      <li><a href="#nested-resources---hasmany">Nested Resources - has_manyな場合</a></li>
      <li><a href="#member-collection---">member, collection - ルーティングを追加</a></li>
      <li><a href="#membercollection--match-">member,collection と match の合わせ技</a></li>
    </ul>
  </li>
  <li><a href="#non-resourceful-routes">Non-Resourceful Routes</a>    <ul>
      <li><a href="#dynamic">dynamic</a></li>
      <li><a href="#static">static</a></li>
      <li><a href="#query-strings">query strings</a></li>
      <li><a href="#defaults">defaults</a></li>
      <li><a href="#naming---match">naming - matchでも名前を付ける</a></li>
      <li><a href="#constraints-http-verb---http">constraints (HTTP verb) - HTTPメソッドで制約する</a></li>
      <li><a href="#constraints-parameter---">constraints (parameter) - パラメータに制約する</a></li>
      <li><a href="#constraints-request---">constraints (request) - リクエストで制約をする</a></li>
      <li><a href="#advanced-constraints---">Advanced Constraints - 制約クラス</a></li>
      <li><a href="#glob">glob</a></li>
      <li><a href="#redirection">redirection</a></li>
      <li><a href="#rack">Rack</a></li>
      <li><a href="#root">root</a></li>
    </ul>
  </li>
  <li><a href="#customized-resource">Customized Resource</a></li>
  <li><a href="#section-1">こんなこともできました</a>    <ul>
      <li><a href="#resourcesmatch">resourcesでmatchを使う</a></li>
    </ul>
  </li>
  <li><a href="#section-2">参考</a></li>
</ul>

<h2 id="section">はじめに</h2>

<p>これはRails3のルーティングを理解するための自分用メモです。</p>

<h2 id="rails">ルーティングとRails</h2>

<p>ルーティングとは「URL」と「コントローラー、アクション、パラメータ」とのマッピングのこと。</p>

<p><a href="http://guides.rubyonrails.org/routing.html">公式のガイド</a>にはこう書いてある。</p>

<blockquote>
  <p>The Rails router recognizes URLs and dispatches them to a controller’s action. It can also generate paths and URLs, avoiding the need to hardcode strings in your views.</p>

  <p>訳: RailsのルーターはURLを確認して、コントローラのアクションに処理を振り分けまする。また、パスやURLを生成することで、ビューへのハードコード避けることもできます。</p>
</blockquote>

<p>「URL =&gt; アクション」だけでなく、「アクション =&gt; URL」も可能だそうだ。</p>

<p>ガイドに沿って、まずは最もシンプルな例を試してみる。Railsでは<code>config/routes.rb</code>にDSLで記述する。Rails2とRails3ではかなり書き方が違うので注意する（後方互換性はある？）。</p>

<pre><code># -- config/routes.rb

match "/patients/:id" =&gt; "patients#show"
</code></pre>

<p>この一行で「<code>/patients/17</code> に HTTP GET すると、PatientsController の show アクションが呼ぶ」という設定になる。</p>

<p>さらに（resourcesなどで設定していれば）ビューではこのような記述ができる</p>

<pre><code># @patient = Patient.find(17)
&lt;%= link_to "Patient Record", patient_path(@patient) %&gt;
</code></pre>

<p><code>patient_path(@patient)</code> は <code>/patients/17</code> を返す。これを<strong>named helper</strong>と呼ぶらしい。</p>

<p>Railsでは「パス」と「URL」を区別している。URLはスキーム、ドメイン名を含む文字列<code>http://example.com/hoge/moge/</code>でパスは<code>/hoge/moge</code>の部分。ふだんはパスを使って、必要な時だけURLを使うようにするといい。<code>patient_url(@patient)</code>でURLを取得できる。</p>

<p>コンソールから<code>rake routes</code>を実行すると、ルーティングの設定を確認できる。これはroutes.rbを書き換えた後や、現在の構成を確認したい場合など、頻繁に使うことになるだろう。</p>

<p>named helperを<code>rails console</code>で試す場合は<code>app.users_path</code>で呼び出すことができる。</p>

<p>Railsでのルーティングは<code>resources</code>を上手く使うのがコツらしい。
<code>resources</code>を使うとリソース（って何なんだという話だけど）のCRUD（Create, Read, Update, Delete）を行うルーティングが一度に生成される。これを使うと一貫性があり、記述量を減らすことができる。詳しくは<a href="http://ja.wikipedia.org/wiki/REST">REST</a>へ。</p>

<h2 id="resource-routing">Resource Routing</h2>

<p>基本の設定</p>

<pre><code>resources :photos
</code></pre>

<p>PhotosControllerに対して7つのルートを生成する。</p>

<pre><code>HTTP Verb  Path             action    named_helper 
---------  -----            ------    ----------
GET        /photos          index     photos_path 
GET        /photos/new      new       new_photo_path
POST       /photos          create    photos_path
GET        /photos/:id      show      photo_path(:id)
GET        /photos/:id/edit edit      edit_photo_path(:id)
PUT        /photos/:id      update    photo_path(:id)
DELETE     /photos/:id      destroy   photo_path(:id)
</code></pre>

<p>Railsではこんな遷移を想定しているようです。</p>

<pre><code>index (GET /photos)
  |
  |-- (GET /photos/new)      --&gt; new 
  |                               |
  |                               `-- (POST /photos) --&gt; create
  |
  |-- (GET /photos/:id)      --&gt; show
  |
  |-- (GET /photos/:id/edit) --&gt; edit 
  |                               |
  |                               `--(PUT /photos/:id)--&gt; update
  |
  `-- (DELETE /photos/:id)   --&gt; destroy
</code></pre>

<h3 id="resources---">resources - 基本</h3>

<pre><code># PhotosControllerにひもづける
resources :photos

# 複数の場合は一行でもOK
resources :photos, :books, :users
</code></pre>

<h3 id="resource---id">resource - idを伴わない場合</h3>

<p>例えば、各ユーザーのプロフィールなど。
コントローラは<code>ProfileController</code>ではなく、<code>ProfilesController</code>になるので注意（resourcesも同時使う場合に同じコントローラ使いたいだろうということらしい）。</p>

<pre><code>resource :profile
</code></pre>

<p><code>resources</code>と異なるのは「index がない」「:id がない」の２点</p>

<pre><code>GET        /profile/new      new       new_profile_path
POST       /profile          create    profile_path
GET        /profile          show      profile_path
GET        /profile/edit     edit      edit_profile_path
PUT        /profile          update    profile_path
DELETE     /profile          destroy   profile_path
</code></pre>

<h3 id="namespace---path-and-controller-prefix">namespace - path and controller prefix</h3>

<p>namespaceはpathとcontrollerに付けられるprefix</p>

<pre><code>namespace :admin do
  # Admin::PhotosController
  resources :photos
end


# HTTP Verb  Path               action  named helper 
# ---------  -----              ------  ----------
# GET        /admin/photos      index   admin_photos_path 
# GET        /admin/photos/new  new     new_admin_photo_path
#   省略...
# 
</code></pre>

<h3 id="scope---controller-prefix">scope - controller prefix</h3>

<p>controllerのみprefixを付ける。</p>

<pre><code>scope :module =&gt; "admin" do
  # Admin::PhotosController
  resources :photos
end
</code></pre>

<p>または</p>

<pre><code># Admin::PhotosController
resources :photos, :module =&gt; "admin"
</code></pre>

<p>Path, named helperにはつかない。内部の構成をモジュール化したい場合に使える。</p>

<pre><code># HTTP Verb  Path         action  named helper 
# ---------  -----        ------  ----------
# GET        /photos      index   photos_path 
# GET        /photos/new  new     new_photo_path
#   省略...
# 
</code></pre>

<h3 id="scope---path-prefix">scope - path prefix</h3>

<p>pathのみprefixを付ける場合</p>

<pre><code>scope "/admin" do    
  resources :photos
end
</code></pre>

<p>または</p>

<pre><code># :path は絶対パスで
resources :photos, :path =&gt; '/admin/photos'
</code></pre>

<p>コントローラーとnamed helperには影響しない。URLだけ変更したい場合に使う。</p>

<pre><code># HTTP Verb  Path               action  named helper 
# ---------  -----              ------  ----------
# GET        /admin/photos      index   photos_path 
# GET        /admin/photos/new  new     new_photo_path
#   省略...
# 
</code></pre>

<p><code>:path</code>を使えば自由にパスを変更できる</p>

<pre><code># photo_index   GET  /hoge  photo#index
# :path は相対パスで
resources :photos, :path =&gt; 'hoge' 
</code></pre>

<h3 id="nested-resources---hasmany">Nested Resources - has_manyな場合</h3>

<pre><code>resources :photos do
  resources :comments
end 

# photo_comments GET /photos/:photo_id/comments     comments#index
# photo_comment  GET /photos/:photo_id/comments/:id comments#show
</code></pre>

<p>ネストは何階層でも可能だけど、混乱をまねくため１階層以上にすべきではない。named helperも長くなる。</p>

<h3 id="member-collection---">member, collection - ルーティングを追加</h3>

<p>基本の7ルート以外のルートを追加したい場合は<code>member</code>か<code>collection</code>を使う。memberは:id付きのルートで、collectionは:idなしのルート。</p>

<p><code>GET /photos/:id/preview</code> で preview アクションが呼ばれるようにするためにはこうする。</p>

<pre><code>resources :photos do
  member do
    get 'preview'
  end
  # または
  # get 'preview', :on =&gt; :member
end
</code></pre>

<p><code>GET /photos/search</code>で search アクションが呼ばれるようにするためにはこうする。</p>

<pre><code>resources :photos do
  collection do
    get 'search'
  end
  # または
  # get 'search', :on =&gt; :collection
end
</code></pre>

<h3 id="membercollection--match-">member,collection と match の合わせ技</h3>

<p>いちいち定義するのは面倒なので match を使います。</p>

<pre><code># TODO named helperも自動生成できないだろうか...
# /hotels/:action hotels#(?-mix:[^0-9]+)

resources :hotels do
  collection do
    # 数字の場合は :id に流れるようにする
    match ':action', :action =&gt; /[^0-9]+/
  end
end
</code></pre>

<h2 id="non-resourceful-routes">Non-Resourceful Routes</h2>

<h3 id="dynamic">dynamic</h3>

<p>このようなルート設定で、</p>

<pre><code>match ':controller(/:action(/:id))'
</code></pre>

<p><code>GET /photos/show/1/2</code>すると、パラメータはこうなる。</p>

<pre><code>{ :controller =&gt; “photos”, :action =&gt; “show”, :id =&gt; “1”, :user_id =&gt; “2” }
</code></pre>

<p>パラメータは自由に追加できる</p>

<pre><code>match ':controller/:action/:id/:user_id'
</code></pre>

<p>namespace, :moduleと、matchの:controllerは同時には使えない。そういう場合はこうする。</p>

<pre><code>match ':controller(/:action(/:id))', :controller =&gt; /admin\/[^\/]+/
</code></pre>

<h3 id="static">static</h3>

<p>URLに特定の文字列を含むような場合。</p>

<p>このような設定で、</p>

<pre><code>match ':controller/:action/:id/with_user/:user_id'
</code></pre>

<p><code>GET /photos/show/1/with_user/2</code> するとパラメータはこうなる</p>

<pre><code>{ :controller =&gt; “photos”, :action =&gt; “show”, :id =&gt; “1”, :user_id =&gt; “2” }
</code></pre>

<h3 id="query-strings">query strings</h3>

<p>このルーティングで、</p>

<pre><code>match ':controller/:action/:id'
</code></pre>

<p><code>GET /photos/show/1?user_id=2</code>すると</p>

<pre><code>{ :controller =&gt; “photos”, :action =&gt; “show”, :id =&gt; “1”, :user_id =&gt; “2” }
</code></pre>

<p><code>GET /photos/show/1?id=2</code> この場合はどうなるか？<code>:id =&gt; '1'</code>になる。クエリ文字列よりも:idの方が優先されるようだ。</p>

<h3 id="defaults">defaults</h3>

<pre><code># GET /photos/1
# { :controller =&gt; "photos", :action =&gt; "show", :id =&gt; "1", :format =&gt; "jpg"
match 'photos/:id' =&gt; 'photos#show', :defaults =&gt; { :format =&gt; 'jpg' }
</code></pre>

<h3 id="naming---match">naming - matchでも名前を付ける</h3>

<pre><code># logout_path, logout_url
match 'exit' =&gt; 'sessions#destroy', :as =&gt; :logout
</code></pre>

<h3 id="constraints-http-verb---http">constraints (HTTP verb) - HTTPメソッドで制約する</h3>

<p><code>/photos/show</code>かつGETメソッドに限定する</p>

<pre><code>match 'photos/show' =&gt; 'photos#show', :via =&gt; :get

# 短縮形
get 'photos/show'
</code></pre>

<p>複数のメソッドを付けられる</p>

<pre><code>match 'photos/show' =&gt; 'photos#show', :via =&gt; [:get, :post]
</code></pre>

<h3 id="constraints-parameter---">constraints (parameter) - パラメータに制約する</h3>

<p>これは、</p>

<pre><code>match 'photos/:id' =&gt; 'photos#show', :constraints =&gt; { :id =&gt; /[A-Z]\d{5}/ }

# これも同じ
match 'photos/:id' =&gt; 'photos#show', :id =&gt; /[A-Z]\d{5}/ 
</code></pre>

<p><code>/photos/A12345</code>のようなパスにマッチする。</p>

<p>制約は正規表現を受け取るが、<code>^ $ \b \B</code>は使えない。でも先頭に固定されているので使う必要がない。</p>

<h3 id="constraints-request---">constraints (request) - リクエストで制約をする</h3>

<p><a href="http://api.rubyonrails.org/classes/ActionDispatch/Request.html">ActionDispatch::Request</a>オブジェクトのメソッドで制約がかけられる。</p>

<pre><code>match "photos", :constraints =&gt; {:subdomain =&gt; "admin"}

# ブロックを与えることもできる
namespace "admin" do
  constraints :subdomain =&gt; "admin" do
    resources :photos
  end
end
</code></pre>

<h3 id="advanced-constraints---">Advanced Constraints - 制約クラス</h3>

<pre><code>match "*path" =&gt; "blacklist#index", :constraints =&gt; BlacklistConstraint.new

class BlacklistConstraint
  def matches?(request)
    # マッチするならtrue 
  end
end
</code></pre>

<h3 id="glob">glob</h3>

<p>これは、</p>

<pre><code>match 'photos/*other' =&gt; 'photos#unknown'
</code></pre>

<p>こうなる。</p>

<pre><code># GET /photos/12               :other =&gt; "12"
# GET /photos/long/path/to/12, :other =&gt; "long/path/to/12".
</code></pre>

<p>これは、</p>

<pre><code>match 'books/*section/:title' =&gt; 'books#show'
</code></pre>

<p>こうなる。</p>

<pre><code># GET /books/some/section/last-words-a-memoir
# {:section =&gt; "some/section", :title =&gt; "last-words-a-memoir"}
</code></pre>

<h3 id="redirection">redirection</h3>

<p>301 “Moved Permanently” redirectになります。</p>

<pre><code>match "/stories" =&gt; redirect("/posts")

# 値を引き継ぐ場合
match "/stories/:name" =&gt; redirect("/posts/%{name}")

# ブロックでもいいよ
match "/stories/:name" =&gt; redirect {|params| "/posts/#{params[:name].pluralize}" }
match "/stories" =&gt; redirect {|p, req| "/posts/#{req.subdomain}" }
</code></pre>

<h3 id="rack">Rack</h3>

<p>TODO </p>

<pre><code>match "/application.js" =&gt; Sprockets
</code></pre>

<h3 id="root">root</h3>

<pre><code># GET /   =&gt; PagesController, 'main' action
root :to =&gt; 'pages#main'
</code></pre>

<h2 id="customized-resource">Customized Resource</h2>

<p>TODO</p>

<h2 id="section-1">こんなこともできました</h2>

<h3 id="resourcesmatch">resourcesでmatchを使う</h3>

<pre><code>resources :users do
  member do
    match 'category/:category', :action =&gt; :show, :as =&gt; :category
  end
  resources :images do
    collection do
      match 'category/:category', :action =&gt; :index, :as =&gt; :category
    end
  end
end
</code></pre>

<p>$ rake routes</p>

<pre><code>category_user        /users/:id/category/:category(.:format)             users#show
category_user_images /users/:user_id/images/category/:category(.:format) images#index
</code></pre>

<h2 id="section-2">参考</h2>

<ul>
  <li><a href="http://d.hatena.ne.jp/willnet/20100424/1272119369">http://d.hatena.ne.jp/willnet/20100424/1272119369</a></li>
  <li><a href="http://guides.rubyonrails.org/routing.html">http://guides.rubyonrails.org/routing.html</a></li>
  <li><a href="http://wiki.usagee.co.jp/ruby/rails/RailsGuides%E3%82%92%E3%82%86%E3%81%A3%E3%81%8F%E3%82%8A%E5%92%8C%E8%A8%B3%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F%E3%82%88/Rails%20Routing%20from%20the%20Outside%20In">http://wiki.usagee.co.jp/ruby/rails/RailsGuides…</a></li>
</ul>


  </div>
  <footer> 
  <p>Last updated at <time>2012-08-12 10:13:28 +0900</time></p>
  <!-- <p>Published at <time>2012-07-20</time></p> -->
  </footer>
</article>




      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31706657-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  </body>
</html>
