---
layout: posts
title: RSpec
tags: ruby
---

## 基本的な書き方

テスト対象のクラスを用意します。

<pre><code data-language="ruby"># lib/user.rb

describe User do

  def initialize(first, last)
    @first = first
    @last = last
  end

  def full_name
    @first + " " + @last
  end

  def admin?
    false
  end

end

</code></pre>

スペックを記述します。

<pre><code data-language="ruby"># spec/user_spec.rb
require 'rspec'
require 'user'

describe User do

  # テスト対象
  subject{ User.new('Taro', 'Tanaka') }

  # エクスペクテーション
  its(:full_name){ should eq "Taro Tanaka" }
  
  # 以下３つ同じ意味
  its(:admin?){ should be_false }

  it "is not admin" do
    expect(subject.admin?).to be_false
  end
  
  it { expect(subject).not_to be_admin }
  
end
</code></pre>

実行します。

    $ bundle exec rspec -cfd spec/user_spec.rb

    User
      is not admin
      should not be admin
      full_name
        should eq "Taro Tanaka"
      admin?
        should be false

    Finished in 0.00291 seconds
    4 examples, 0 failures


## ベストプラクティス

<http://betterspecs.org/> を参考にします。
これ以外にも色々ベストプラクティスがあり、結構好みの問題もあるようです。

### describeではRubyドキュメント規約に従う

describe内の文字列はだらだらと説明文を書くのではなく、`describe ".class_method" do` や `describe "#instance_method" do` のようにメソッド名を書いて簡潔にする。

### contextを使う

「もし〜な状態だったらこれ、そうでなければそれ」っていうスペックを記述する場合は `context` で分ける。

contextの説明は "when" か "with" で始める。

### 説明文を短く

itの説明文は40文字以上長くするべきではない。もしそうなったら、contextを使って分ける。
また、expectationを正しく使えば、読みやすい出力にすることができる。

    # good
    context 'when not valid' do
      it { should respond_with 422 }
    end

    # output
    when not valid
      it should respond with 422

### subjectを使う

テスト対象の主語が同じ場合は`subject`を使うとDRYになる。

    subject { assigns('message') }
    it { should match /it was born in Billville/ }

変数のようにアクセスすることもできる。

    subject(:hero) { Hero.first }
    it "should be equipped with a sword" do
      hero.equipment.should include "sword"
    end

### letとlet!を使う

beforeでインスタンス変数をセットするんだったら、`let`を使いましょう。
これを使うと変数が遅延ロードされ、itテストブロック内ではキャッシュされたオブジェクトが返されます。（メモ化）

`let!`はフックの前に呼び出す？
<https://www.relishapp.com/rspec/rspec-core/v/2-11/docs/helper-methods/let-and-let>


### モックを使うべきかどうか

モックは使用するのが難しいが、素早くスペックを記述することができる。


### その他

- １つのテストにアサーションは１つだけにすること
- 全ての可能性をテストすること


## リンク

[スはスペックのス 【第 1 回】 RSpec の概要と、RSpec on Rails (モデル編)](http://jp.rubyist.net/magazine/?cmd=view&p=0021-Rspec&key=rspec) まず最初に読むならこれ。

[RSpecのshouldはもう古い！新しい記法expectを使おう！](http://qiita.com/items/d880250adc8cdbe7a32f)
[rspec-expectations](https://github.com/rspec/rspec-expectations)

[RSpec ベストプラクティス](http://jp.rubyist.net/magazine/?0032-TranslationArticle)


